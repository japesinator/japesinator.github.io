<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title> Let's Write a Monad in Idris! </title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

        <!-- Favicon -->
        <link rel="apple-touch-icon" sizes="57x57" href="/ico/apple-icon-57x57.png">
        <link rel="apple-touch-icon" sizes="60x60" href="/ico/apple-icon-60x60.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/ico/apple-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="76x76" href="/ico/apple-icon-76x76.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/ico/apple-icon-114x114.png">
        <link rel="apple-touch-icon" sizes="120x120" href="/ico/apple-icon-120x120.png">
        <link rel="apple-touch-icon" sizes="144x144" href="/ico/apple-icon-144x144.png">
        <link rel="apple-touch-icon" sizes="152x152" href="/ico/apple-icon-152x152.png">
        <link rel="apple-touch-icon" sizes="180x180" href="/ico/apple-icon-180x180.png">
        <link rel="icon" type="image/png" sizes="192x192"  href="/ico/android-icon-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/ico/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="96x96" href="/ico/favicon-96x96.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/ico/favicon-16x16.png">
        <link rel="manifest" href="/manifest.json">
        <meta name="msapplication-TileColor" content="#ffffff">
        <meta name="msapplication-TileImage" content="/ico/ms-icon-144x144.png">
        <meta name="theme-color" content="#ffffff">

    </head>
    <body>

      <div id="container">

        <div class="left">
          <h1>JP Writes Code</h1>
          <img id="about" src="/img/logo.png" height="75px" width="75px" /><br />	

          <strong>navigation</strong><br />
          <a href="/">home</a> <br />
          
          <a class="about" href="https://github.com/japesinator">github</a><br />
          
          <a class="about" href="mailto:jp@writes.co.de">email</a><br />
          
          <a class="about" href="https://twitter.com/japesinator">twitter</a><br />
          
          <a class="about" href="/about">about</a><br />
          
          <a class="about" href="/search">search</a><br />
          

          
          <div id="about">
            <strong>about</strong><br />
            I am a high school student in the midwest who likes math, computers, and other interesting things
          </div>
          
        </div>

        <div class="right">

          <h1>Let's Write a Monad in Idris!</h1>
<span class="time">24 Oct 2014</span>

<div class="content">
	<div class="post"><p>To preface this, I&#39;m not writing another monad tutorial.  There&#39;s a
(not-too-far-from-the-truth) stereotype that every Haskell programmer writes
their own terrible monad tutorial that I do not intend to perpetuate, and if
you really want to learn monads, I would recommend first reading the excellent
<a href="http://blog.sigfpe.com/2006/08/you-could-have-invented-monads-and.html">You Could Have Invented
Monads</a>
and then writing a bunch of monadic code (Note: the second part of this is much
more important than the first.)  This instead assumes you have a basic idea of
what a monad is, and want to get started using them in Idris.</p>

<p>Whenever I personally am getting started with a new topic in Idris (or most
languages, really) I start by playing around with it in the REPL. <code>:t Monad</code> is
the expression to get the type of <code>Monad</code>, and this returns
<code>Prelude.Monad.Monad : (Type -&gt; Type) -&gt; Type</code>.  <code>:doc Monad</code> is slightly more
helpful, returning</p>

<div class="highlight"><pre><code class="language-idris" data-lang="idris"><span class="kt">Type</span> <span class="kr">class</span> <span class="kt">Monad</span>

<span class="nf">Parameters</span><span class="ow">:</span>
    m

<span class="nf">Methods</span><span class="ow">:</span>
    <span class="ow">(&gt;&gt;=)</span> <span class="ow">:</span> <span class="kt">Monad</span> m <span class="ow">=&gt;</span> m a <span class="ow">-&gt;</span> <span class="ow">(</span>a <span class="ow">-&gt;</span> m b<span class="ow">)</span> <span class="ow">-&gt;</span> m b

        <span class="kr">infixl</span> <span class="mi">5</span>

<span class="nf">Instances</span><span class="ow">:</span>
    <span class="kt">Monad</span> id
    <span class="kt">Monad</span> <span class="kt">PrimIO</span>
    <span class="kt">Monad</span> <span class="kt">IO</span>
    <span class="kt">Monad</span> <span class="kt">Maybe</span>
    <span class="kt">Monad</span> <span class="ow">(</span><span class="kt">Either</span> e<span class="ow">)</span>
    <span class="kt">Monad</span> <span class="kt">List</span>
    <span class="kt">Monad</span> <span class="ow">(</span><span class="kt">Vect</span> n<span class="ow">)</span>
    <span class="kt">Monad</span> <span class="kt">Stream</span></code></pre></div>

<p>The most interesting thing that I personally found here is that Idris only
requires one operator (<code>&gt;&gt;=</code>) to declare an instance of <code>Monad</code>.  This is a far
cry from the Haskell I learned about monads from, which requires <code>&gt;&gt;=</code>, <code>&gt;&gt;</code>,
<code>return</code>, and <code>fail</code> to be defined on anything you want to make a monad. 
Curious, I went to the
<a href="https://github.com/Idris-lang/Idris-dev/blob/master/libs/prelude/Prelude/Monad.idr">source
code</a>
to learn a bit more about how exactly one can do the work of four functions
with only one.  The actual definition of <code>Monad</code> there is quite interesting:</p>

<div class="highlight"><pre><code class="language-idris" data-lang="idris"><span class="kr">class</span> <span class="kt">Applicative</span> m <span class="ow">=&gt;</span> <span class="kt">Monad</span> <span class="ow">(</span>m <span class="ow">:</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span><span class="ow">)</span> <span class="kr">where</span>
<span class="ow">(&gt;&gt;=)</span> <span class="ow">:</span> m a <span class="ow">-&gt;</span> <span class="ow">(</span>a <span class="ow">-&gt;</span> m b<span class="ow">)</span> <span class="ow">-&gt;</span> m b</code></pre></div>

<p>In Idris, monads are a kind of applicatives!  This actually makes a lot of
sense from a category theory perspective, as monads are actually applicative,
but is still slightly surprising.  Since we&#39;re already looking around in Idris&#39;
source code, we may as well look at <a href="https://github.com/Idris-lang/Idris-dev/blob/master/libs/prelude/Prelude/Applicative.idr">the source for
<code>Applicative</code></a>
which defines <code>Applicative</code> as:</p>

<div class="highlight"><pre><code class="language-idris" data-lang="idris"><span class="kr">class</span> <span class="kt">Functor</span> f <span class="ow">=&gt;</span> <span class="kt">Applicative</span> <span class="ow">(</span>f <span class="ow">:</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span><span class="ow">)</span> <span class="kr">where</span>
<span class="nf">pure</span> <span class="ow">:</span> a <span class="ow">-&gt;</span> f a
<span class="ow">(&lt;$&gt;)</span> <span class="ow">:</span> f <span class="ow">(</span>a <span class="ow">-&gt;</span> b<span class="ow">)</span> <span class="ow">-&gt;</span> f a <span class="ow">-&gt;</span> f b</code></pre></div>

<p>Notably, <code>Applicative</code> itself is a subclass of <code>Functor</code>, which also makes
sense (an applicative is literally just a functor with application), and
looking at one more <a href="https://github.com/Idris-lang/Idris-dev/blob/master/libs/prelude/Prelude/Functor.idr">bit of the
source</a>
we can finally see all the stuff that goes into being a monad in Idris:</p>

<div class="highlight"><pre><code class="language-idris" data-lang="idris"><span class="lineno">1</span> <span class="kr">class</span> <span class="kt">Functor</span> <span class="ow">(</span>f <span class="ow">:</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span><span class="ow">)</span> <span class="kr">where</span>
<span class="lineno">2</span> <span class="nf">map</span> <span class="ow">:</span> <span class="ow">(</span>m <span class="ow">:</span> a <span class="ow">-&gt;</span> b<span class="ow">)</span> <span class="ow">-&gt;</span> f a <span class="ow">-&gt;</span> f b</code></pre></div>

<p>A few things immediately become a bit clearer now that we can see how to
declare a function from a type to a type a monad from start to finish.  First,
there actually are four operations that any monad has to have defined (<code>map</code>
from <code>Functor</code>, <code>pure</code> and <code>&lt;$&gt;</code> from <code>Applicative</code>, and <code>&gt;&gt;=</code> from <code>Monad</code>).
While those aren&#39;t the same four as Haskell, they&#39;re roughly
equivalent.<code>return</code> is just <code>pure</code>, <code>&gt;&gt;</code> is quite easy to rewrite if you should
want it (it&#39;s a specific case of <code>$&gt;</code>, which is defined in
<code>Prelude.Applicative</code>)(and not necessary for being a monad, technically
speaking), and <code>fail</code> is actually not even part of the definition of a monad,
and is just useful for graceful failure in pattern-matchy <code>do</code> expressions.</p>

<p>Just to ensure that I truly understood Monads in Idris, I decided to rewrite
<code>Maybe</code>.  In Haskell, for comparison:</p>

<div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="lineno"> 1</span> <span class="kr">data</span> <span class="kt">Maybe</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">Nothing</span>
<span class="lineno"> 2</span>              <span class="o">|</span> <span class="kt">Just</span> <span class="n">a</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> <span class="kr">instance</span> <span class="kt">Monad</span> <span class="kt">Maybe</span> <span class="kr">where</span>
<span class="lineno"> 5</span>     <span class="p">(</span><span class="kt">Just</span> <span class="n">x</span><span class="p">)</span> <span class="o">&gt;&gt;=</span> <span class="n">k</span>      <span class="ow">=</span> <span class="n">k</span> <span class="n">x</span>
<span class="lineno"> 6</span>     <span class="kt">Nothing</span>  <span class="o">&gt;&gt;=</span> <span class="kr">_</span>      <span class="ow">=</span> <span class="kt">Nothing</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>     <span class="p">(</span><span class="kt">Just</span> <span class="kr">_</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="n">k</span>      <span class="ow">=</span> <span class="n">k</span>
<span class="lineno"> 9</span>     <span class="kt">Nothing</span>  <span class="o">&gt;&gt;</span>  <span class="kr">_</span>      <span class="ow">=</span> <span class="kt">Nothing</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>     <span class="n">return</span>              <span class="ow">=</span> <span class="kt">Just</span>
<span class="lineno">12</span>     <span class="n">fail</span> <span class="kr">_</span>              <span class="ow">=</span> <span class="kt">Nothing</span></code></pre></div>

<p>First, <code>Maybe</code> is defined and then an instance of <code>Monad</code> is written for it.
In <code>Idris</code>, we start the same way, by defining the type (or function to a type,
really):</p>

<div class="highlight"><pre><code class="language-idris" data-lang="idris"><span class="lineno">1</span> <span class="kr">data</span> <span class="kt">Maybe</span> a <span class="ow">=</span> <span class="kt">Nothing</span>
<span class="lineno">2</span>              <span class="ow">|</span> <span class="kt">Just</span> a</code></pre></div>

<p>So far, this is exactly the same.  However, in Idris, before we can declare our
instance of <code>Monad</code> we need an instance of <code>Applicative</code>, for which we need an
instance of <code>Functor</code>.</p>

<div class="highlight"><pre><code class="language-idris" data-lang="idris"><span class="lineno">1</span> <span class="kr">instance</span> <span class="kt">Functor</span> <span class="kt">Maybe</span> <span class="kr">where</span>
<span class="lineno">2</span>     map f <span class="ow">(</span><span class="kt">Just</span> x<span class="ow">)</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="ow">(</span>f x<span class="ow">)</span>
<span class="lineno">3</span>     map f <span class="kt">Nothing</span> <span class="ow">=</span> <span class="kt">Nothing</span></code></pre></div>

<p>Then we can define <code>Applicative</code>:</p>

<div class="highlight"><pre><code class="language-idris" data-lang="idris"><span class="lineno">1</span> <span class="kr">instance</span> <span class="kt">Applicative</span> <span class="kt">Maybe</span> <span class="kr">where</span>
<span class="lineno">2</span>     pure <span class="ow">=</span> <span class="kt">Just</span>
<span class="lineno">3</span> 
<span class="lineno">4</span>     <span class="ow">(</span><span class="kt">Just</span> f<span class="ow">)</span> <span class="ow">&lt;$&gt;</span> <span class="ow">(</span><span class="kt">Just</span> a<span class="ow">)</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="ow">(</span>f a<span class="ow">)</span>
<span class="lineno">5</span>     <span class="kr">_</span> <span class="ow">&lt;$&gt;</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">Nothing</span></code></pre></div>

<p>And finally <code>Monad</code>:</p>

<div class="highlight"><pre><code class="language-idris" data-lang="idris"><span class="lineno">1</span> <span class="kr">instance</span> <span class="kt">Monad</span> <span class="kt">Maybe</span> <span class="kr">where</span>
<span class="lineno">2</span>     <span class="kt">Nothing</span> <span class="ow">&gt;&gt;=</span> k <span class="ow">=</span> <span class="kt">Nothing</span>
<span class="lineno">3</span>     <span class="ow">(</span><span class="kt">Just</span> x<span class="ow">)</span> <span class="ow">&gt;&gt;=</span> k <span class="ow">=</span> k x</code></pre></div>
</div>
</div>


          <footer>
             
            <p>JP Smith made this</p>
            
          </footer>
        </div>

      </div>

    </body>
</html>
